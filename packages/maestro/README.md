# ILO Design System - Maestro

The Maestro package is a utility package that provides abstractions for [Storybook](https://storybook.js.org/) to support the [twig](https://twig.symfony.com/) components. You can also consider this package as a low-level equivalent of the [wingsuit](https://github.com/wingsuit-designsystem/wingsuit)

## Pre-requisites

In order to understand maestro, you should have a basic knowledge of the following:

- [UI Patterns](https://www.drupal.org/project/ui_patterns)
- [Storybook](https://storybook.js.org/)
- [Drupal JS API](https://www.drupal.org/docs/drupal-apis/javascript-api/javascript-api-overview)

## Installation

To install the Maestro package, you can run the following command:

```bash
npm i @ilo-org/maestro
```

## Configuration

The Maestro package has three major exports.

- `@ilo-org/maestro` - The main export that introduces a `Maestro` object
- `@ilo-org/maestro/storybook` - The storybook decorators/helpers
- `@ilo-org/maestro/plugin` - A vite plugin that helps to compile the twig components

To start with maestro, you need a `html` storybook template with vite as a builder tool

```bash
npx storybook@latest init --type="html"
```

After the project is scaffolded, you can start adding the maestro package.

### Vite plugin

First, we need to add vite plugin from maestro to storybook's vite config `vite.config.js`

```js
import { defineConfig } from "vite";
import { join } from "node:path";

import { UIPatterns } from "@ilo-org/maestro/plugin";

export default defineConfig({
  plugins: UIPatterns({
    namespaces: {
      components: join(__dirname, "..", "src/components"),
    },
  }),
});
```

The plugin supports the following properties.

- `namespaces` - A key-value pair of namespace and the path to the components directory
- `globals` - A key-value pair of global variables that should be available in the twig components
- `dynamics` - An array of component names that are using dynamic(contactable) twig components
  Here is a quick example of the dynamic component

```twig
<div class="{{prefix}}--tabs--content">
  {% for item in items %}
    <div id="tab--{{tabids[loop.index - 1]}}" role="tabpanel" aria-labelledby="tab--{{tabids[loop.index - 1]}}" {% if loop.index == 1 %}aria-expanded="true"{% else %}aria-expanded="false"{% endif %}>
      {% include '@components/' ~ item.component ~ '/' ~ item.component ~ '.twig' with item.componentdata %}
    </div>
  {% endfor %}
</div>
```

### Storybook decorators

To enable Drupal's JS API in the storybook, you need first to add `Behavior Decorator` to the storybook's preview file

```js
import { BehaviorDecorator } from "@ilo-org/maestro/storybook";

/** @type { import('@storybook/html').Preview } */
const preview = {
  decorators: [BehaviorDecorator],
};

export default preview;
```

and then you need to inject the `head` property to the storybook config and merge the vite config with the plugin mentioned above

```js
import { mergeConfig } from "vite";
import alternate from "./vite.config.js";

import { head } from "@ilo-org/maestro/storybook";


/** @type { import('@storybook/html-vite').StorybookConfig } */
const config = {
  stories: [
    "../stories/**/*.mdx",
    "../stories/**/*.stories.@(js|jsx|mjs|ts|tsx)",
  ],
  staticDirs: ["../public"],
  core: {
    builder: "@storybook/builder-vite",
  },
  addons: [...],
  framework: {
    name: getAbsolutePath("@storybook/html-vite"),
    options: {},
  },
  viteFinal: (config) => {
    return mergeConfig(alternate, config);
  },
  previewHead: head,
};
export default config;
```

### Creating a story

To create a story you need to use the main `Maestro` object. Maestro has a `create` method that accepts the following:

- component (actual twig component)
- pattern definition (ui pattern definition in yaml)

And in return, you get the object.

```bash
{
  meta: {...}
  stories: [...],
}
```

The stories key will always have 1 element, which is the Default story, and if the pattern definition has any variants, you will get all other stories in an array

Here's an example of how to create a story

```js
import Accordion from "../components/accordion/accordion.twig";
import AccordionPatterns from "../components/accordion/accordion.pattern.yml";
import { Maestro } from "@ilo-org/maestro";

const story = Maestro.create(Accordion, AccordionPatterns);

const Meta = {
  title: "Components/Content/Accordion",
  tags: ["autodocs"],
  ...story.meta,
};

const [Default, Scrollable, Focus] = story.stories;

export default Meta;

export { Default, Scrollable, Focus };
```

##### Variants

There are a few rules for variants:

- Variants will inherit any setting from the default definition
- Variants named default will be ignored because Default is generated by the pattern definition itself
